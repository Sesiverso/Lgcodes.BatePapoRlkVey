// Importa as funções necessárias do SDK do Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// Configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAfVXG-xIe4FyPpsNTtmV__HutzOQFgaVQ",
    authDomain: "votacao-da4e2.firebaseapp.com",
    projectId: "votacao-da4e2",
    storageBucket: "votacao-da4e2.appspot.com",
    messagingSenderId: "696185234268",
    appId: "1:696185234268:web:37e1ddd097dfeea95a9799",
    measurementId: "G-PY9XXN0ESV"
};

// Inicializa o Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Inicializa votos se não existirem
const initializeVotes = () => {
    const options = ['Tenho mas não posso levar', 'Não', 'Tenho e posso levar'];
    options.forEach(option => {
        const voteRef = ref(database, `votes/${option}`);
        onValue(voteRef, snapshot => {
            if (snapshot.val() === null) {
                set(voteRef, 0);
            }
        });
    });
};

// Carrega e exibe os votos
const loadVotes = () => {
    const options = ['Tenho mas não posso levar', 'Não', 'Tenho e posso levar'];
    options.forEach(option => {
        const voteRef = ref(database, `votes/${option}`);
        onValue(voteRef, snapshot => {
            const count = snapshot.val() || 0;
            document.getElementById(`count-${option}`).textContent = count;
        });
    });
};

// Envia um voto
const submitVote = () => {
    const selectedOption = document.querySelector('input[name="material"]:checked');
    if (!selectedOption) {
        alert('Selecione uma opção para votar.');
        return;
    }

    const option = selectedOption.value;
    const voteRef = ref(database, `votes/${option}`);
    update(voteRef, (currentValue) => (currentValue || 0) + 1);

    localStorage.setItem('voted', 'true');
};

// Envia uma mensagem no chat
const sendMessage = () => {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();

    if (message === '') return;

    const messageObject = {
        message: message,
        timestamp: new Date().toISOString()
    };

    const messagesRef = ref(database, 'messages');
    push(messagesRef, messageObject);
    messageInput.value = '';
};

// Exibe mensagens no chat
const displayMessages = () => {
    const messagesRef = ref(database, 'messages');
    onValue(messagesRef, snapshot => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        snapshot.forEach(childSnapshot => {
            const message = childSnapshot.val().message;
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
};

// Carrega votos e mensagens ao carregar a página
window.onload = () => {
    initializeVotes();
    loadVotes();
    displayMessages();
};

// Adiciona eventos aos botões
document.querySelector('button[onclick="submitVote()"]').addEventListener('click', submitVote);
document.querySelector('button[onclick="sendMessage()"]').addEventListener('click', sendMessage);
