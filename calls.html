<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamada</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            align-items: center;
        }
        #video-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            height: 100%;
            max-height: 600px;
            position: relative;
        }
        #local-video, #remote-videos {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            background-color: #000;
        }
        #local-video {
            position: absolute;
            bottom: 0;
        }
        #controls {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            width: 100%;
        }
        #controls button {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            margin: 0 10px;
        }
        #controls button:hover {
            background-color: #0056b3;
        }
        #participant-list {
            margin-top: 10px;
        }
        #participant-list img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        #participant-list div {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="local-video" autoplay muted></video>
        <div id="remote-videos"></div>
    </div>
    <div id="controls">
        <button id="end-call">Encerrar Chamada</button>
        <button id="start-call">Iniciar Chamada</button>
    </div>
    <div id="participant-list"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDcTM9uPHMF5jRNtQfog1fL1EhFef6AvD8",
            authDomain: "calls-6220c.firebaseapp.com",
            databaseURL: "https://calls-6220c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "calls-6220c",
            storageBucket: "calls-6220c.appspot.com",
            messagingSenderId: "343752930832",
            appId: "1:343752930832:web:77c750525d72f2dcbb3c95",
            measurementId: "G-DHBGBERJEN"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let localStream;
        let remoteStreams = {};
        let peerConnections = {};
        const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // Iniciar o acesso ao microfone
        async function startCall() {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            document.getElementById('local-video').srcObject = localStream;

            // Adicionar a lógica para iniciar uma chamada com WebRTC
            // Implementar sinalização e troca de ICE aqui

            // Atualizar a lista de participantes
            updateParticipantList();
        }

        // Encerrar a chamada
        document.getElementById('end-call').addEventListener('click', () => {
            for (const peerId in peerConnections) {
                peerConnections[peerId].close();
            }
            localStream.getTracks().forEach(track => track.stop());
            setTimeout(() => {
                window.location.href = 'chat.html'; // Redirecionar para o chat após 3 segundos
            }, 3000);
        });

        // Atualizar a lista de participantes
        function updateParticipantList() {
            const participantsRef = database.ref('participants');
            participantsRef.on('value', snapshot => {
                const participants = snapshot.val();
                const participantList = document.getElementById('participant-list');
                participantList.innerHTML = '';
                for (const [id, participant] of Object.entries(participants)) {
                    const participantDiv = document.createElement('div');
                    participantDiv.innerHTML = `
                        <img src="${participant.img}" alt="Profile Image">
                        <span>${participant.name}</span>
                    `;
                    participantList.appendChild(participantDiv);
                }
            });
        }

        // Solicitar acesso ao microfone e iniciar a chamada ao carregar a página
        window.onload = async function() {
            await startCall();
        };

        // Implementar sinalização e troca de ICE (Intercâmbio de informações de controle e de mídia)
        // Aqui você deve adicionar a lógica para sinal
